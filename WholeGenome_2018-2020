# Boulder Chickadee Study
# Whole genome analysis of 2018, 2019, 2020 samples
#Kathryn Grabenstein
# 17 Dec 2021

#Goal: Quantify hybridization between BCCH and MOCH in Boulder, CO using whole genome samples from 2018, 2019, & 2020 breeding season.



## Overview of workflow

# Samples have all already been demultiplexed, begin with trimming & qc
 
# Step 1: Trim & qc
# Step 2: Assembly and prep for variant calling
# Step 3: Call variants
# Step 4: merge, genotype, and filter
# Step 5: Calculate hybrid indexes for all individuals using fixed SNPs

#General how tos
########################
#open up new screen
screen

#escape screen
CTRL + AD

#see running screens
screen -list

#reconnect to screen
screen -r [INSERT SCREEN ID]

#kill screen
#reconnect to screen and then type "exit"

#kill screen
screen -X -S [session # you want to kill] quit

#############################

##### Step 1: Trim & qc

# Move all scripts from local computer to working directory
#navigate to local computer on terminal
scp /Users/kathryngrabenstein/Documents/Data Analysis/Chickadee Whole Genome/ *.sh kagr3234@chickadee:/data1/kagr.wgs.chickadee

# Move adapter sequence file from local computer to working directory
#navigate to local computer on terminal
scp /Users/kathryngrabenstein/Documents/Data Analysis/Chickadee \Whole \Genome/TruSeq3-PE.fa kagr3234@chickadee:/data1/kagr.wgs.chickadee

# Move samples from nas to data1
#move fastq files to working directory
#move into directory where files are located

#move 2018 samples
cp -r *.gz /data1/kagr.wgs.chickadee/fastq

# dont move 2019 files bc already have trimmed files
#move trimmed 2019 files to trimmed_fastq folder

#move 2020 raw files
cp **/*.gz /data1/kagr.wgs.chickadee/fastq

#get rid of A prefix for 2020 samples
rename 's/A*//' *.fq.gz

#make sure naming system consistent for 2018 and 2020
rename 's/_1.fq.gz/_R1_001.fastq.gz/g' *_1.fq.gz

rename 's/_2.fq.gz/_R2_001.fastq.gz/g' *_2.fq.gz

# Generate list of samples to trim
#from fastq directory
ls -1 > 2020_Chickadee_WGS_Samples.txt

#move txt file to working directory
mv 2020_Chickadee_WGS_Samples.txt /data1/kagr.wgs.chickadee/

#remove prefixes from sample txt file for trimmomatic
sed -i 's/_R1_001.fastq.gz//g' 2020_Chickadee_WGS_Samples.txt
sed -i 's/_R2_001.fastq.gz//g' 2020_Chickadee_WGS_Samples.txt

#remove duplicates
uniq 2020_Chickadee_WGS_Samples.txt > 2020_Chickadee_WGS_Samples_1.txt

#rename file
mv 2020_Chickadee_WGS_Samples_1.txt 2020_Chickadee_WGS_Samples.txt

# Run trim script
bash trim-and-QC.sh -i 2020_Chickadee_WGS_Samples.txt -p /data1/kagr.wgs.chickadee/fastq/ -f R1_001.fastq.gz -r R2_001.fastq.gz -a TruSeq3-PE.fa -t 18

#check pre-trimmed and post-trimmed QC scores
#use multiqc

#download multiqc
#into working directory
pip install multiqc --user

#run multiqc
multiqc .

#move multiqc file to local computer
scp kagr3234@chickadee:/data1/kagr.wgs.chickadee/post_trim_QC_files/multiqc_report.html /Users/kathryngrabenstein/Documents/Data\ Analysis/Chickadee\ Whole\ Genome/

scp kagr3234@chickadee:/data1/kagr.wgs.chickadee/pre_trim_QC_files/multiqc_report.html /Users/kathryngrabenstein/Documents/Data\ Analysis/Chickadee\ Whole\ Genome/


#############################
#Step 2: Align and Sort

##prep work for align and sort; ie manage all the new trimmed files
#copy trimmed 2018 & 2020 back to raw folders to save for previous use (ie if updating ref in future)
#move trimmed to master trimmed directory

##### copy 2018 trimmed to master 2018 folder
#make file with all sample names for 2018
#navigate to 2018 directory
ls > chickadee.wgs.2018.txt

#change suffixes to match trimmed files
sed -i 's/_R2_001.fastq.gz//g' chickadee.wgs.2018.txt
sed -i 's/_R1_001.fastq.gz//g' chickadee.wgs.2018.txt

#remove duplicates (shouldn't be any?)
uniq chickadee.wgs.2018.txt > chickadee.wgs.2018_1.txt

#rename file
mv chickadee.wgs.2018_1.txt chickadee.wgs.2018.txt

#copy ALL trimmed files to 2018/trimmed master directory for posterity 
#four files for every sample
for file in $(cat /nas/chickadee.wgs/2018/chickadee.wgs.2018.txt); do scp /data1/kagr.wgs.chickadee/fastq/"$file"_trimmed_2P.fq.gz /nas/chickadee.wgs/2018/trimmed/; done

for file in $(cat /nas/chickadee.wgs/2018/chickadee.wgs.2018.txt); do scp /data1/kagr.wgs.chickadee/fastq/"$file"_trimmed_1P.fq.gz /nas/chickadee.wgs/2018/trimmed/; done

for file in $(cat /nas/chickadee.wgs/2018/chickadee.wgs.2018.txt); do scp /data1/kagr.wgs.chickadee/fastq/"$file"_trimmed_2U.fq.gz /nas/chickadee.wgs/2018/trimmed/; done

for file in $(cat /nas/chickadee.wgs/2018/chickadee.wgs.2018.txt); do scp /data1/kagr.wgs.chickadee/fastq/"$file"_trimmed_1U.fq.gz /nas/chickadee.wgs/2018/trimmed/; done



###### copy 2020 trimmed
#make sample list for 2020
ls > chickadee.wgs.2020.txt

#get rid of A prefix for 2020 samples
sed -i 's/A*//' chickadee.wgs.2020.txt

#copy ALL trimmed 2020 files to master 2020/trimmed directory for posterity
#four files for every sample

for file in $(cat /nas/chickadee.wgs/2020/chickadee.wgs.2020.txt); do scp /data1/kagr.wgs.chickadee/trimmed_fastq/"$file"_trimmed_2P.fq.gz /nas/chickadee.wgs/2020/trimmed/; done

for file in $(cat /nas/chickadee.wgs/2020/chickadee.wgs.2020.txt); do scp /data1/kagr.wgs.chickadee/trimmed_fastq/"$file"_trimmed_1P.fq.gz /nas/chickadee.wgs/2020/trimmed/; done

for file in $(cat /nas/chickadee.wgs/2020/chickadee.wgs.2020.txt); do scp /data1/kagr.wgs.chickadee/fastq/"$file"_trimmed_2U.fq.gz /nas/chickadee.wgs/2020/trimmed/; done

for file in $(cat /nas/chickadee.wgs/2020/chickadee.wgs.2020.txt); do scp /data1/kagr.wgs.chickadee/fastq/"$file"_trimmed_1U.fq.gz /nas/chickadee.wgs/2020/trimmed/; done


##now that everything has been "backed up", move trimmed fastq to trimmed_fastq with 2019 data

#move trimmed 2018 & 2020 from fastq to trimmed_fastq
mv *fq.gz /data1/kagr.wgs.chickadee/trimmed_fastq/


# make MASTER sample file with 2018, 2019 & 2020 data
#navigate to trimmmed_fastq
ls > chickadee.wgs.MASTER.txt

#remove suffixes 1P, 2P, 1U, 2U so only sample name 
sed -i 's/_trimmed_*1P.fq.gz//g' chickadee.wgs.MASTER.txt
sed -i 's/_trimmed_*2P.fq.gz//g' chickadee.wgs.MASTER.txt
sed -i 's/_trimmed_*1U.fq.gz//g' chickadee.wgs.MASTER.txt
sed -i 's/_trimmed_*2U.fq.gz//g' chickadee.wgs.MASTER.txt


#remove duplicates (shouldn't be any?)
uniq chickadee.wgs.MASTER.txt > chickadee.wgs.MASTER_1.txt

#rename file
mv chickadee.wgs.MASTER_1.txt chickadee.wgs.MASTER.txt

#move sample file to working directory
mv chickadee.wgs.MASTER.txt /data1/kagr.wgs.chickadee/

##Open screen for this command so runs in the background
bash align-and-sort.sh -i chickadee.wgs.MASTER.txt -r /data1/kagr.wgs.chickadee/reference.BCCH.genome.2021/BCCH.reference.final.fasta -t 18 -p /data1/kagr.wgs.chickadee/trimmed_fastq/

#############################
## Need to merge bams for 2018 data
##Use merge_bams.sh


#copy 2018 bam files to new directory in case make mistake, so don't have to remake bam files
#make directory for bam to merge
mkdir 2018_bams_to_merge

#copy 2018 bam files to directory
for file in $(cat chickadee.wgs.2018.txt); do scp /data1/kagr.wgs.chickadee/bam_files/"$file".bam /data1/kagr.wgs.chickadee/2018_bams_to_merge/; done

#copy 2018 file list to edit to remove lane info
cp chickadee.wgs.2018.txt chickadee.wgs.2018.no.lane.txt

#edit 2018 file list to use with merge_bams.sh to include ONLY sample ID, no lane info
sed -i 's/_S.*//g' chickadee.wgs.2018.no.lane.txt

#remove duplicates (shouldn't be any?)
uniq chickadee.wgs.2018.no.lane.txt > chickadee.wgs.2018.no.lane_1.txt

#rename file
mv chickadee.wgs.2018.no.lane_1.txt chickadee.wgs.2018.no.lane.txt

#edit merge script for file paths for txt file and output directory in vim

#navigate to /data1/kagr.wgs.chickadee/bam_files
#run merge_bam.sh

#reconnect to screen to merge

bash merge_bams.sh

#re-loop through sort bams, and mark RGs and duplicates
#delete the old sorted bam for each lane... 


###Broken pipe bc ran out of space

#moved necessary fastq files bc deleted them
######NEED TO UPDATE WHEN DONE MOVING FASTQ, pre trim
for file in $(cat broken.pipe.chickadee.wgs.txt); do scp /data1/kagr.wgs.chickadee/bam_files/"$file".bam /data1/kagr.wgs.chickadee/trimmed_fastq/; done

bash align-and-sort.sh -i broken.pipe.chickadee.wgs.txt -r /data1/kagr.wgs.chickadee/reference.BCCH.genome.2021/BCCH.reference.final.fasta -t 18 -p /data1/kagr.wgs.chickadee/trimmed_fastq/















